---
trigger: model_decision
description: 需求澄清与确认规范
---

## 澄清流程

### 触发方式

用户可以通过以下方式触发单个需求的澄清：

```
用户: "澄清 REQ-001"
或
用户: "REQ-003 需要确认一下业务规则"
或
用户: "针对创建智能员工接口有几个问题"
```

### Step 1: 识别目标需求

Agent 根据用户输入，从 `decomposition.md` 中定位到具体需求：

```
输入: "澄清 REQ-001"
↓
查找: decomposition.md 中 REQ-001 的内容
↓
输出: 需求详情
  - 需求 ID: REQ-001
  - 服务归属: [mall-admin]
  - 描述: 管理后台创建智能员工接口
  - 当前状态: 待澄清
```

### Step 2: 生成问题清单

针对**单个需求**生成 `questions/{req_id}.md`：

```markdown
# 需求澄清问题清单

## 目标需求

- **需求 ID**: REQ-001
- **服务归属**: [mall-admin]
- **描述**: 管理后台创建智能员工接口

## 问题列表

### 高优先级（阻塞开发）

| 序号 | 问题 | 提出原因 | 建议方案 | 状态 | 用户确认 |
|------|------|----------|----------|------|----------|
| 1 | 智能员工名称唯一性要求 | 影响数据库索引和校验逻辑 | 建议同一租户下唯一 | 🔄 进行中 | - |
| 2 | 创建时是否需要绑定技能 | 影响接口参数设计 | 建议支持可选技能列表 | ⏳ 待确认 | - |

### 中优先级（影响设计）

| 序号 | 问题 | 提出原因 | 建议方案 | 状态 | 用户确认 |
|------|------|----------|----------|------|----------|
| 3 | 创建后是否自动激活 | 影响状态机设计 | 建议默认激活 | ⏳ 待确认 | - |

### 低优先级（可后续优化）

...
```

### Step 3: 交互式逐个澄清（ReAct 模式）

采用 ReAct (Reasoning + Acting) 模式，**逐个问题**进行交互式澄清：

#### 3.1 分析问题并生成选项

对于每个问题，Agent 分析业务背景，生成 **2-4 个澄清选项 + 1 个自定义选项**：

- 选项应覆盖常见业务场景
- 标记推荐选项
- 必须包含"其他（自定义）"选项

**示例：**

```
问题：智能员工名称唯一性要求？

分析：
- 影响数据库索引设计
- 影响业务校验逻辑
- 需要考虑多租户场景

生成选项：
A. 全局唯一（整个系统名称唯一）
B. 租户内唯一（同一租户下名称唯一）[推荐]
C. 不限制唯一性，允许重复
D. 其他（请描述具体需求）
```

#### 3.2 逐个询问用户

**每次只问一个问题**，使用选项形式：

```
【REQ-001 | 问题 1/5 | 高优先级】智能员工名称唯一性要求？

影响：数据库索引设计、业务校验逻辑

A. 全局唯一（整个系统名称唯一）
B. 租户内唯一（同一租户下名称唯一）[推荐]
C. 不限制唯一性，允许重复
D. 其他（请描述具体需求）
```

#### 3.3 处理用户选择

- **选择 A/B/C**：直接记录选项值
- **选择 D（其他）**：继续追问具体需求，然后记录

#### 3.4 实时更新文档

每确认一个问题，**实时更新** `questions/{req_id}.md` 和 `answers/{req_id}.md`：

```markdown
## 问题列表（实时更新）

| 序号 | 问题 | 状态 | 用户确认 |
|------|------|------|----------|
| 1 | 名称唯一性 | ✅ 已确认 | 租户内唯一 |
| 2 | 绑定技能 | 🔄 进行中 | - |
```

```markdown
## 问题确认结果（实时更新）

| 序号 | 原始问题 | 用户确认 | 最终决策 | 确认时间 |
|------|----------|----------|----------|----------|
| 1 | 名称唯一性 | 租户内唯一 | 同一租户下名称唯一 | 2026-02-25 10:30 |
```

#### 3.5 继续下一个问题

完成当前问题后，自动进入下一个问题，直到所有问题澄清完毕。

### Step 4: 记录确认结果

所有问题确认完成后，`answers/{req_id}.md` 完整内容：

```markdown
# 需求澄清确认

## 目标需求

- **需求 ID**: REQ-001
- **服务归属**: [mall-admin]
- **描述**: 管理后台创建智能员工接口

## 确认时间

2026-02-25

## 确认方式

交互式对话确认（逐个问题）

## 问题确认结果

| 序号 | 原始问题 | 用户确认 | 最终决策 |
|------|----------|----------|----------|
| 1 | 名称唯一性 | 租户内唯一 | 同一租户下名称唯一 |
| 2 | 绑定技能 | 必须绑定 | 必填技能列表，至少一个 |
| 3 | 自动激活 | 默认激活 | 创建后状态为"已激活" |

## 影响范围

- **接口参数**: 需要添加 skills 字段（必填）
- **数据库**: 需要添加唯一索引（tenant_id + name）
- **业务逻辑**: 创建后自动设置状态为激活
```

### Step 5: 技术决策记录

基于澄清结果，更新或创建 `decisions/{req_id}.md`：

```markdown
# 技术决策记录 (ADR)

## 关联需求

REQ-001: 管理后台创建智能员工接口

## ADR-001-1: 智能员工唯一性约束

- **日期**: 2026-02-25
- **状态**: 已确认
- **背景**: REQ-001 确认名称需要唯一性约束
- **决策**: 数据库添加联合唯一索引（tenant_id, name）
- **理由**:
    - 业务要求同一租户下名称唯一
    - 避免重复创建导致的混淆
- **影响**:
    - 数据库表结构变更
    - Service 层需要捕获唯一性冲突异常

## ADR-001-2: 技能绑定策略

- **日期**: 2026-02-25
- **状态**: 已确认
- **背景**: REQ-001 确认创建时必须绑定至少一个技能
- **决策**: skills 字段为必填，创建时校验至少一个技能
- **理由**:
    - 智能员工必须具备至少一项能力
    - 避免创建空壳智能员工
- **影响**:
    - Request DTO 中 skills 字段标记 @NotEmpty
    - Service 层添加业务校验
```

---

## 验收标准

需求澄清阶段完成的标准：

- [ ] 所有高优先级问题已得到确认
- [ ] 技术决策已记录并关联到需求
- [ ] 模糊点已消除，可以进入技术设计
- [ ] 用户已确认 `answers.md` 内容

---

## 进入下一阶段

澄清完成后，触发 **技术规格书生成** 阶段。